# -*- coding: utf-8 -*-
"""
Created on Thu Dec 18 17:52:34 2025

@author: navar
"""

# -*- coding: utf-8 -*-
r"""
Topoplots MMN y P3b — SOLO EEG (evita canales con posiciones solapadas)

Usa epochs ya filtrados 0.5–30:
  ...\eeg_step5_epochs\eeg_epo.fif
"""

from pathlib import Path
import mne
import matplotlib.pyplot as plt

BASE = Path(r"C:\Users\navar\Desktop\sub-P01\sub-P01")
EPO_PATH = BASE / "eeg_step5_epochs" / "eeg_epo.fif"

DEVIANTS = ["Stimulus/S 41", "Stimulus/S 25"]
EARLY_STANDARDS = ["Stimulus/S 35", "Stimulus/S 19"]
LATE_STANDARDS  = ["Stimulus/S 39", "Stimulus/S 23"]

MMN_WIN = (0.10, 0.20)
P3B_WIN = (0.30, 0.60)

def combine_epochs(ep, events, label):
    out = mne.concatenate_epochs([ep[e] for e in events])
    print(f"{label}: n={len(out)}")
    return out

def evoked_mean(evoked, tmin, tmax):
    e = evoked.copy().crop(tmin=tmin, tmax=tmax)
    data = e.data.mean(axis=1, keepdims=True)
    return mne.EvokedArray(data, e.info, tmin=0.0)

def plot_topo(evoked, title):
    fig = evoked.plot_topomap(
        times=[0.0],
        ch_type="eeg",
        colorbar=True,
        scalings=1,
        show=False,
    )
    try:
        fig.suptitle(title)
    except Exception:
        pass
    plt.show()

def main():
    epochs = mne.read_epochs(EPO_PATH, preload=True, verbose="error")

    # ✅ 1) QUEDARSE SOLO CON EEG (esto elimina SC*, S*, AC, TH6, ENG*, ECG, VEOG, HEOG, etc.)
    epochs = epochs.copy().pick_types(eeg=True)

    # (opcional) ver qué queda
    print(f"EEG channels kept: {len(epochs.ch_names)}")

    # ✅ 2) poner montage SOLO a EEG
    montage = mne.channels.make_standard_montage("standard_1020")
    epochs.set_montage(montage, on_missing="ignore")

    # Grupos
    ep_dev   = combine_epochs(epochs, DEVIANTS, "Deviant")
    ep_early = combine_epochs(epochs, EARLY_STANDARDS, "Early")
    ep_late  = combine_epochs(epochs, LATE_STANDARDS, "Late")

    evo_dev   = ep_dev.average()
    evo_early = ep_early.average()
    evo_late  = ep_late.average()

    # Diferencias
    diff_dev_early = mne.combine_evoked([evo_dev, evo_early], weights=[1, -1])
    diff_dev_late  = mne.combine_evoked([evo_dev, evo_late],  weights=[1, -1])

    # Topos por ventana
    mmn = evoked_mean(diff_dev_early, *MMN_WIN)
    plot_topo(mmn, f"MMN topo (Dev–Early) | mean {MMN_WIN[0]:.2f}-{MMN_WIN[1]:.2f}s")

    p3b = evoked_mean(diff_dev_late, *P3B_WIN)
    plot_topo(p3b, f"P3b topo (Dev–Late) | mean {P3B_WIN[0]:.2f}-{P3B_WIN[1]:.2f}s")

if __name__ == "__main__":
    main()
